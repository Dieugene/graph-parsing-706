# Калибровка на главе 34: промпты и JSON-схема

## 1. Анализ главы 34

### 1.1. Характеристики

- **Объём:** ~7800 токенов, 17 пунктов (34.1–34.17)
- **Тема:** дополнительные документы для регистрации выпуска ценных бумаг, размещаемых путём подписки
- **Структурный паттерн:** все пункты ссылаются на главу 5 как на базовый пакет документов

### 1.2. Выявленные паттерны текста

**Паттерн 1 — требования к документам (пп. 34.1–34.13).** Шаблон:

> «Для [действие] [тип бумаги] в [регистратор] дополнительно к документам, представляемым в соответствии с главой 5 настоящего Положения, должны быть представлены: [список документов]»

Это основной контент для графа.

**Паттерн 2 — условия на документах.** Внутри списка — конструкции «в случае, если...», определяющие, когда документ требуется.

**Паттерн 3 — процедурные правила (пп. 34.14–34.17).** Ограничения и правила процедуры, НЕ содержащие требований к документам. LLM должна их распознать и пометить как пропущенные.

**Паттерн 4 — вариативность регистратора.** Регистратор меняется от пункта к пункту:

| Пункт | Регистратор |
|-------|------------|
| 34.1, 34.3 | Банк России или регистратор |
| 34.2, 34.4–34.7, 34.12–34.13 | Банк России |
| 34.8 | Банк России или биржа |
| 34.9–34.11 | Банк России, биржа или центральный депозитарий |

### 1.3. Типы условий, встреченные в главе 34

| Категория | Пример | Частота |
|-----------|--------|---------|
| Тип эмитента по регулированию | «эмитент — кредитная организация» (34.4, 34.13) | Высокая |
| Специальный статус эмитента | «специализированное общество» (34.6), «унитарное предприятие» (34.11) | Средняя |
| Тип обеспечения облигации | «с залоговым обеспечением» (34.5), «с разной очередностью» (34.7) | Средняя |
| Наличие/отсутствие проспекта | «не сопровождающегося регистрацией проспекта» (34.8, 34.10) | Средняя |
| Особые обстоятельства | «на стадии внешнего управления» (34.3), «во исполнение договора конвертируемого займа» (34.2) | Низкая |
| Способ оплаты | «оплата неденежными средствами» (34.4), «оплата ОФЗ» (34.13) | Низкая |
| Характеристики облигации | «без срока погашения» (34.12) | Низкая |
| Государственное участие | «акционером является государство, владеющее >25%» (34.1) | Низкая |

Высокочастотные условия → кандидаты на развилки. Низкочастотные → кандидаты на одиночные условия на рёбрах.

### 1.4. Перекрёстные ссылки

| Тип ссылки | Примеры | Обработка |
|-----------|---------|-----------|
| На другую главу 706-П | «глава 5» (все пункты) | pending_ref |
| На конкретную статью ФЗ | «п. 5 ст. 41 ФЗ Об АО», «п. 1 ст. 22 ФЗ О РЦБ» | Бэклог вопросов к ФЗ |
| На ФЗ целиком | «ФЗ О приватизации» | Бэклог |
| Внутри пункта | «абзацем третьим настоящего пункта» | Резолвится сразу (контекст в окне) |
| На Указ Президента | «Указ Президента РФ №81» | Бэклог |

## 2. Промпты

### 2.1. Промпт уровня 1 — карта главы

```
## Задача

Ты анализируешь текст одной главы из Положения Банка России №706-П — 
нормативного акта, регулирующего процедуру эмиссии ценных бумаг 
в Российской Федерации.

Твоя задача — составить краткую карту главы: какие пункты о чём, 
какие факторы создают различия в требованиях к документам.

Карта будет использоваться как справочный контекст при последующем 
детальном разборе каждого пункта.

## Формат ответа

Тема главы: [одно предложение]

Пункты:
- [номер]: [одно предложение — что описывает пункт] [тип: документы | правило]
- [номер]: ...

Факторы, влияющие на различия в требованиях:
- [наименование фактора]: [какие значения встречаются] (пункты: [...])
- ...

## Правила

1. Тип «документы» — пункт описывает, какие документы нужно представить.
2. Тип «правило» — пункт описывает ограничения или процедурные правила, 
   но НЕ требования к документам.
3. В список факторов включай только те, которые создают различия 
   в наборе документов между пунктами (тип эмитента, тип обеспечения, 
   вид подписки и т.д.).
4. Будь максимально компактен. Карта не должна превышать 500 токенов.

## Текст главы

{chapter_text}
```

### 2.2. Промпт уровня 2 — извлечение фактов из окна

```
## Задача

Ты анализируешь фрагмент Положения Банка России №706-П — нормативного акта, 
регулирующего процедуру эмиссии ценных бумаг в Российской Федерации.

Задача: извлечь из текста структурированное описание требований 
к документам для регистрации ценных бумаг.

## Карта главы (справочно)
{chapter_map}

## Текст для анализа (пункты {from_paragraph}–{to_paragraph})
{window_text}

## Что извлечь

Для каждого пункта, который описывает требования к документам, извлеки:

### 1. Регистрационное действие
Какая процедура описана. Укажи:
- Полное наименование действия, ДОСЛОВНО из текста
- Тип ценной бумаги, к которому относится действие
- Регистратор(ы), указанные в тексте
- Номер пункта

### 2. Перечень документов
Для каждого документа, который «должен быть представлен»:
- Полное наименование документа, ДОСЛОВНО из текста
- Номер пункта и абзаца (например: «п. 34.5 абз. 2»)
- Условие представления: текст после «в случае, если...», 
  или null если документ требуется безусловно
- Краткое описание содержания, если в тексте указано, 
  что документ «должен содержать» определённые сведения

### 3. Факторы и условия
Какие факторы определяют, что данный пункт применяется:
- Наименование фактора
- Значение фактора в данном пункте
- Номер пункта

### 4. Перекрёстные ссылки
Все ссылки на другие части 706-П и на иные нормативные акты:
- Номер пункта, в котором встречена ссылка
- Куда ведёт ссылка (глава/пункт/приложение 706-П, или статья ФЗ)
- Тип: ссылка внутри 706-П / ссылка на приложение 706-П / ссылка на ФЗ / иное
- Контекст (зачем ссылка)

### 5. Пропущенные пункты
Пункты, НЕ содержащие требований к документам: номер и причина пропуска.

## Формат ответа

Верни JSON:

{
  "analyzed_paragraphs": [
    {
      "paragraph_number": "34.5",
      "registration_action": {
        "name_verbatim": "государственная регистрация выпуска (дополнительного выпуска) облигаций с залоговым обеспечением",
        "security_type": "облигации с залоговым обеспечением",
        "registrar": ["Банк России"],
        "legal_ref": "п. 34.5"
      },
      "documents": [
        {
          "name_verbatim": "копия отчета оценщика об определении рыночной стоимости имущества, являющегося предметом залога по облигациям",
          "legal_ref": "п. 34.5 абз. 2",
          "condition": "в случае привлечения оценщика для определения рыночной стоимости указанного имущества в соответствии с требованиями законодательства Российской Федерации",
          "content_requirements": "копия разделов отчета, содержащих основные факты и выводы (резолютивной части), сведения о заказчике оценки и об оценщике, копия страницы с подписью оценщика"
        },
        {
          "name_verbatim": "документ, подтверждающий наличие у залогодателя недвижимого имущества и (или) ценных бумаг, залогом которых обеспечивается исполнение обязательств по облигациям",
          "legal_ref": "п. 34.5 абз. 3",
          "condition": null,
          "content_requirements": null
        }
      ],
      "factors": [
        {
          "factor_name": "тип обеспечения облигаций",
          "factor_value": "залоговое обеспечение",
          "legal_ref": "п. 34.5"
        }
      ],
      "cross_references": [
        {
          "from_paragraph": "34.5",
          "target": "глава 5",
          "target_type": "internal_706p",
          "context": "дополнительно к документам, представляемым в соответствии с главой 5"
        }
      ]
    }
  ],
  "skipped_paragraphs": [
    {
      "paragraph_number": "34.14",
      "reason": "процедурное правило о праве предлагать бумаги до регистрации, не содержит требований к документам"
    }
  ]
}

## Правила

1. Извлекай наименования документов и действий ДОСЛОВНО из текста. 
   Не перефразируй и не сокращай. Используй поля name_verbatim.
2. Каждый абзац, описывающий отдельный документ — отдельный элемент 
   в массиве documents.
3. Конструкция «дополнительно к документам, представляемым 
   в соответствии с главой X» — это перекрёстная ссылка, 
   а НЕ документ. Помещай в cross_references.
4. Если условие представления документа содержит несколько подусловий 
   (через «и»/«или»), сохраняй полный текст условия как есть.
   Разбиение на отдельные условия — задача следующего этапа.
5. Пункты, не содержащие требований к документам — 
   в skipped_paragraphs с указанием причины.
6. Пометки «(в ред. Указания Банка России от ...)» — игнорируй.
7. Если в тексте встречается ссылка на другой пункт этой же главы 
   или на другую главу и тебе нужен контекст для корректного извлечения — 
   используй tool get_paragraphs для получения текста по номеру пункта, 
   или get_appendix для получения структуры приложения.
```

### 2.3. Промпт для нечёткого сравнения сущностей

Вызывается алгоритмом, когда точный поиск по реестру не дал результата, но есть кандидаты с частичным совпадением.

```
## Задача

Определи, описывают ли два наименования одну и ту же сущность 
в контексте регулирования эмиссии ценных бумаг (Положение Банка России №706-П).

## Наименование A (из реестра)
{entity_a_name}
Тип: {entity_a_type}
Контекст появления: {entity_a_context}

## Наименование B (из текста)
{entity_b_name}
Тип: {entity_b_type}
Контекст появления: {entity_b_context}

## Ответ

Верни JSON:

{
  "match": "same | variant | different",
  "confidence": число от 0.0 до 1.0,
  "reasoning": "одно предложение"
}

- "same": одна и та же сущность, названа по-разному
- "variant": похожая сущность, но есть содержательные различия 
  (например, два разных документа со схожими названиями)
- "different": разные сущности
```

### 2.4. Промпт для обработки приложений (Фаза 2)

```
## Задача

Ты анализируешь текст одного приложения из Положения Банка России №706-П. 
Приложения содержат утверждённые формы документов, которые эмитенты ценных 
бумаг представляют при регистрации.

Извлеки иерархическую структуру формы: разделы, подразделы, поля.

## Текст приложения
{appendix_text}

## Формат ответа

Верни JSON:

{
  "appendix_number": число,
  "document_name": "полное наименование документа из заголовка",
  "sections": [
    {
      "name": "наименование раздела",
      "order": порядковый номер,
      "subsections": [
        {
          "name": "наименование подраздела",
          "order": порядковый номер,
          "subsections": [ ...рекурсивно, если есть... ],
          "fields": [
            {
              "name": "наименование поля",
              "order": порядковый номер внутри раздела,
              "data_type": "text | date | number | choice | complex",
              "description": "описание или требования к заполнению, если указаны",
              "subfields": [ ...та же структура поля... ] или null
            }
          ]
        }
      ],
      "fields": [
        {
          "name": "наименование поля",
          "order": порядковый номер,
          "data_type": "text | date | number | choice | complex",
          "description": "описание или требования к заполнению, если указаны",
          "subfields": [ ...та же структура поля... ] или null
        }
      ]
    }
  ],
  "deprecated_elements": [
    {
      "name": "наименование элемента с пометкой «Утратили силу»",
      "location": "описание, где находился элемент"
    }
  ]
}

## Правила

1. Иерархия разделов выражается вложенностью: раздел содержит 
   subsections (подразделы) и fields (поля). Подразделы также могут 
   содержать свои subsections и fields. НЕ используй ссылки по имени 
   для указания родительского раздела — только вложенность.
2. Если поле содержит вложенные элементы — используй subfields.
3. data_type = "complex" для полей, представляющих группу связанных данных.
4. Элементы с пометкой «Утратили силу» — НЕ включай в sections, 
   помести в deprecated_elements.
5. Извлекай наименования ДОСЛОВНО из текста.
6. Если раздел не содержит подразделов — subsections = [].
   Если раздел не содержит полей напрямую (только через подразделы) — 
   fields = [].
```

## 3. Логика обработки окна (Фаза 3)

Описание последовательности шагов при обработке одного окна текста. Не псевдокод, а логика взаимодействия LLM и алгоритма.

### Шаг 1. Подготовка контекста (алгоритм)

Оркестратор формирует входные данные для агента:
- Текст окна (пункты N..M)
- Карта главы (из уровня 1)
- Компактный реестр известных сущностей (названия документов, действий, факторов — для ориентации агента)
- Информация о pending_refs, target которых попадает в N..M

### Шаг 2. Извлечение фактов (LLM-агент)

Агент читает текст окна и извлекает структурированные факты: действия, документы, условия, факторы, ссылки. При необходимости — вызывает tools `get_paragraphs` и `get_appendix` для получения контекста по ссылкам.

Выход: JSON с фактами (формат — промпт уровня 2).

### Шаг 3. Сопоставление с реестром (алгоритм)

Для каждого извлечённого наименования (документа, действия, фактора) алгоритм ищет совпадение в реестре:
1. Точный поиск по полному наименованию
2. Если не найдено — поиск по подстроке / нормализованному названию
3. Если найдены кандидаты с частичным совпадением — вызов LLM для нечёткого сравнения (промпт 2.3)
4. Если совпадение не найдено — фиксация как новой сущности

### Шаг 4. Формирование графа (алгоритм)

На основе результатов шагов 2 и 3 алгоритм:
- Присваивает ID новым сущностям
- Создаёт узлы в графе
- Создаёт рёбра (requires_document, branches_by, when_value)
- Для одиночных условий — ставит аннотацию `condition` на ребро
- Для составных условий (AND/OR) — создаёт узлы-развилки
- Обновляет реестр сущностей

### Шаг 5. Обработка ссылок (алгоритм)

- Ссылки на главы/пункты 706-П, которые уже обработаны → резолвинг
- Ссылки на ещё не обработанные части → добавление в pending_refs
- Ссылки на приложения → резолвинг (приложения обработаны на Фазе 2)
- Ссылки на ФЗ → добавление в бэклог вопросов
- Проверка pending_refs: если в текущем окне содержится target какой-либо pending ref → резолвинг

## 4. Пример сериализации фрагмента графа

На основе пункта 34.5 (облигации с залоговым обеспечением).

```json
{
  "nodes": [
    {
      "id": "ra:0042",
      "type": "registration_action",
      "name": "Государственная регистрация выпуска (дополнительного выпуска) облигаций с залоговым обеспечением",
      "parent_id": "ra:0031",
      "legal_ref": ["п. 34.5 706-П"],
      "description": "Гос. регистрация выпуска облигаций с залоговым обеспечением, размещаемых путём подписки"
    },
    {
      "id": "doc:0108",
      "type": "document",
      "name": "копия отчета оценщика об определении рыночной стоимости имущества, являющегося предметом залога по облигациям",
      "synonyms": [],
      "legal_ref": ["п. 34.5 абз. 2 706-П"],
      "appendix_ref": null,
      "doc_type": "supporting"
    },
    {
      "id": "doc:0109",
      "type": "document",
      "name": "документ, подтверждающий наличие у залогодателя недвижимого имущества и (или) ценных бумаг, залогом которых обеспечивается исполнение обязательств по облигациям",
      "synonyms": [],
      "legal_ref": ["п. 34.5 абз. 3 706-П"],
      "appendix_ref": null,
      "doc_type": "supporting"
    },
    {
      "id": "doc:0110",
      "type": "document",
      "name": "справка банка об открытии эмитенту залогового счета",
      "synonyms": [],
      "legal_ref": ["п. 34.5 абз. 4 706-П"],
      "appendix_ref": null,
      "doc_type": "supporting"
    },
    {
      "id": "doc:0111",
      "type": "document",
      "name": "справка эмитента, содержащая сведения о том, какое лицо будет вести учет денежных требований, являющихся предметом залога по облигациям",
      "synonyms": [],
      "legal_ref": ["п. 34.5 абз. 5 706-П"],
      "appendix_ref": null,
      "doc_type": "supporting"
    },
    {
      "id": "doc:0112",
      "type": "document",
      "name": "справка эмитента, подтверждающая, что денежные требования, являющиеся предметом залога по облигациям, не являются предметом еще одного залога",
      "synonyms": [],
      "legal_ref": ["п. 34.5 абз. 6 706-П"],
      "appendix_ref": null,
      "doc_type": "supporting"
    },
    {
      "id": "f:0007",
      "type": "factor",
      "name": "тип обеспечения облигаций",
      "legal_ref": []
    },
    {
      "id": "fv:0021",
      "type": "factor_value",
      "factor_id": "f:0007",
      "name": "залоговое обеспечение",
      "legal_ref": []
    },
    {
      "id": "fv:0022",
      "type": "factor_value",
      "factor_id": "f:0007",
      "name": "поручительство / независимая гарантия",
      "legal_ref": []
    }
  ],
  "edges": [
    {
      "id": "e:0201",
      "type": "branches_by",
      "from": "ra:0031",
      "to": "f:0007"
    },
    {
      "id": "e:0202",
      "type": "when_value",
      "from": "f:0007",
      "to": "ra:0042",
      "factor_value_id": "fv:0021",
      "legal_ref": ["п. 34.5 706-П"]
    },
    {
      "id": "e:0203",
      "type": "requires_document",
      "from": "ra:0042",
      "to": "doc:0108",
      "legal_ref": ["п. 34.5 абз. 2 706-П"],
      "condition": "в случае привлечения оценщика для определения рыночной стоимости указанного имущества в соответствии с требованиями законодательства Российской Федерации"
    },
    {
      "id": "e:0204",
      "type": "requires_document",
      "from": "ra:0042",
      "to": "doc:0109",
      "legal_ref": ["п. 34.5 абз. 3 706-П"]
    },
    {
      "id": "e:0205",
      "type": "requires_document",
      "from": "ra:0042",
      "to": "doc:0110",
      "legal_ref": ["п. 34.5 абз. 4 706-П"],
      "condition": "в случае, если предметом залога по облигациям выступают денежные требования и если решение о выпуске таких облигаций содержит сведения о банковских реквизитах залогового счета"
    },
    {
      "id": "e:0206",
      "type": "requires_document",
      "from": "ra:0042",
      "to": "doc:0111",
      "legal_ref": ["п. 34.5 абз. 5 706-П"]
    },
    {
      "id": "e:0207",
      "type": "requires_document",
      "from": "ra:0042",
      "to": "doc:0112",
      "legal_ref": ["п. 34.5 абз. 6 706-П"]
    }
  ],
  "pending_refs": [
    {
      "id": "pref:0034",
      "source_paragraph": "34.5",
      "target": "глава 5",
      "context": "дополнительно к документам, представляемым в соответствии с главой 5",
      "status": "unresolved"
    }
  ],
  "fz_questions": []
}
```

**Что показывает пример:**
- ID присвоены алгоритмом (числовые, автоинкремент по типу)
- Наименования документов — дословно из текста
- Одиночные условия — на рёбрах (`condition`)
- Развилка по фактору «тип обеспечения» — через узлы `f:0007` → `fv:0021`
- Ссылка на главу 5 — в pending_refs (глава 5 обрабатывается раньше, но для примера показана как unresolved)

## 5. Рекомендации по нарезке на окна

Для главы 34 (~7800 токенов, 17 пунктов):

| Окно | Пункты | Характеристика |
|------|--------|----------------|
| 1 | 34.1–34.3 | Акции: подписка (общие, БР, внешнее управление) |
| 2 | 34.4–34.7 | Облигации: специфика (КО, залог, спецобщество, очерёдность) |
| 3 | 34.8–34.13 | Облигации: проспект, представитель, обеспечение, унитарные, бессрочные, ОФЗ |
| 4 | 34.14–34.17 | Процедурные правила (пропускаются LLM) |

Принципы нарезки:
- Границы по пунктам (не разрезать пункт)
- Размер ~2–3K токенов
- Логически связанные короткие пункты — объединять

## 6. Ожидаемый результат обработки главы 34

| Тип узла | Количество (оценка) | Примечание |
|----------|---------------------|------------|
| registration_action | ~10–13 | По одному на каждый пункт 34.1–34.13, с группировкой подтипов |
| document | ~25–30 | Каждый абзац с описанием документа |
| factor | ~5–8 | Тип обеспечения, тип эмитента, наличие проспекта, и др. |
| factor_value | ~10–15 | Значения факторов |

| Тип ребра | Количество (оценка) |
|-----------|---------------------|
| requires_document | ~25–30 |
| branches_by | ~5–8 |
| when_value | ~10–15 |

| Другие артефакты | Количество |
|------------------|------------|
| pending_refs | ~13 (ссылки на главу 5) |
| fz_questions | ~8–10 (ФЗ Об АО, О РЦБ, О приватизации, Указ №81) |
| skipped_paragraphs | 4 (пп. 34.14–34.17) |

## 7. Открытые вопросы по результатам калибровки

### 7.1. Иерархия vs. развилки для registration_action
Пункт 34.5 описывает «гос. регистрацию выпуска облигаций с залоговым обеспечением, размещаемых путём подписки». Два варианта моделирования:

**Вариант A — глубокая иерархия:** регистрация выпуска → ... путём подписки → ... облигаций с залоговым обеспечением.

**Вариант B — плоское действие + развилки:** одно действие «регистрация выпуска путём подписки», развилки по факторам «тип бумаги» и «тип обеспечения».

Рекомендация: вариант B, потому что иерархия A будет зеркалировать структуру глав документа, а не логику процесса.

### 7.2. Гранулярность содержания документов
Пункт 34.5 абз. 4: «справка банка должна содержать сведения о банковских реквизитах..., об остатке..., об операциях..., о запретах...». Это один документ с описанием содержания.

Рекомендация: на Фазе 3 фиксировать описание содержания как атрибут `content_requirements` узла документа. Детализация до полей — только для документов с формализованной формой (приложения, Фаза 2).

### 7.3. ID-конвенция
Предлагается: тип + числовой автоинкремент (`ra:0001`, `doc:0001`, `f:0001`, `fv:0001`, `e:0001`). Преимущества: простота, уникальность, отсутствие зависимости от LLM. Человекочитаемость — через name, не через id.
